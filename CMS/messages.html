<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>CMS Messages</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
</head>
<body>

<div class="container-fluid h-100">
    <div class="row h-100">
        <!-- Chat room list column -->
        <div class="col-4">
            <div class="list-group">
                <a href="#" class="list-group-item list-group-item-action active">Admin</a>
                <a href="#" class="list-group-item list-group-item-action">Ann Smith</a>
                <a href="#" class="list-group-item list-group-item-action">John Bond</a>
                <a href="#" class="list-group-item list-group-item-action">Ivan Stan</a>
            </div>
            <button class="btn btn-link">+ New chat room</button>
        </div>

        <!-- Chat room details column -->
        <div class="col-8">
            <div class="border-bottom pb-2 mb-2">
                <h5>Chat room Admin</h5>
                <div>Members</div>
                <div>Messages</div>
            </div>
            <div class="overflow-auto" style="height:300px;">
                <!-- Message content would go here -->
            </div>
            <label>
                <textarea class="form-control mt-2" placeholder="Type a message..."></textarea>
            </label>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>

<script>
    (function(){
        const element = function (id) {
            return document.getElementById(id);
        };

        const status = element('status');
        const messages = element('messages');
        const textarea = element('textarea');
        const username = element('username');
        const clearBtn = element('clear');

        const statusDefault = status.textContent;

        const setStatus = function(s){
            status.textContent = s;

            if(s !== statusDefault){
                var delay = setTimeout(function(){
                    setStatus(statusDefault);
                }, 4000);
            }
        }

        // Connect to socket.io
        const socket = io.connect('http://127.0.0.1:4000');

        // Check for connection
        if(socket !== undefined){
            console.log('Connected to socket...');

            socket.on('output', function(data){
                if(data.length){
                    for(let x = 0;x < data.length;x++){
                        // Build out message div
                        let message = document.createElement('div');
                        message.setAttribute('class', 'chat-message');
                        message.textContent = data[x].name+": "+data[x].message;
                        messages.appendChild(message);
                        messages.insertBefore(message, messages.firstChild);
                    }
                }
            });

            // Get Status From Server
            socket.on('status', function(data){
                setStatus((typeof data === 'object')? data.message : data);

                if(data.clear){
                    textarea.value = '';
                }
            });

            // Handle Input
            textarea.addEventListener('keydown', function(event){
                if(event.which === 13 && event.shiftKey == false){
                    // Emit to server input
                    socket.emit('input', {
                        name:username.value,
                        message:textarea.value
                    });

                    event.preventDefault();
                }
            })

            clearBtn.addEventListener('click', function(){
                socket.emit('clear');
            });

            socket.on('cleared', function(){
                messages.textContent = '';
            });
        }
    })();
</script>
</body>
</html>